name: Auto-generate PR body

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate or update PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            if (!pr) return
            const currentBody = pr.body || ''

            // Marker to identify PRs previously generated by this workflow
            const GENERATED_MARKER = '<!-- AUTO-GENERATED-BY: generate-pr-body -->'

            // If the PR body is non-empty and not generated by us, do not overwrite.
            const shouldGenerate = !currentBody.trim() || currentBody.includes(GENERATED_MARKER)
            if (!shouldGenerate) {
              console.log('PR body present and appears manually authored â€” skipping generation')
              return
            }

            const { owner, repo } = context.repo
            const title = pr.title || ''

            // Collect commits and changed files for context
            const commitsResp = await github.rest.pulls.listCommits({ owner, repo, pull_number: pr.number })
            const filesResp = await github.rest.pulls.listFiles({ owner, repo, pull_number: pr.number })

            const commitList = commitsResp.data.map(c => `- ${c.commit.message.split('\n')[0]} (${c.sha.slice(0,7)})`).join('\n') || '- (no commits found)'
            const fileList = filesResp.data.map(f => `- ${f.filename}`).join('\n') || '- (no files found)'

            const generated = `<!-- AUTO-GENERATED-BY: generate-pr-body -->\n\n## Summary\n\nAuto-generated summary for: **${title}**\n\n## What I changed\n\n${fileList}\n\n## Commits\n\n${commitList}\n\n## Why this matters\n\n<!-- Describe the motivation and impact of these changes -->\n\n## How I tested it\n\n<!-- List testing steps, unit/e2e/manual checks performed -->\n\n## Checklist\n\n- [ ] I added tests when applicable\n- [ ] I updated documentation when applicable\n- [ ] My commit messages follow Conventional Commits\n\n---\n\n_Please review and update this description with additional context or testing notes as needed._\n`

            await github.rest.pulls.update({ owner, repo, pull_number: pr.number, body: generated })
